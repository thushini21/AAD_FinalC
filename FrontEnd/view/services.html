<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Services Page</title>
  <link rel="stylesheet" href="../css/service.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.min.css">


</head>
<body>
<!-- Navbar -->
<!--<nav class="navbar">
  <div class="container">
    <a href="#" class="logo">HomeEase</a>
    <ul class="nav-links">
      <li><a href="#" onclick="navigateHome()">Home</a></li>
      <li><a href="#services">Services</a></li>
      </li><li><a href="../view/mybookings.html">Bookings</a></li>
      </li><li><a href="../view/services.html">Notifications</a></li>
    </ul>
    <a href="#profile" class="logout-btn">
      <i class="fas fa-user"></i> Profile &lt;!&ndash; Login icon and text &ndash;&gt;
    </a>
    <div class="hamburger" id="hamburger">
      <i class="fas fa-bars"></i>
    </div>
  </div>
</nav>-->
<!-- Navbar (will be populated by JavaScript) -->
<nav class="navbar">
  <div class="container">
    <!-- Content will be inserted here by renderNavbar() -->
  </div>
</nav>

<!-- Search Section - Add this right after the navbar and before the category section -->
<section class="search-section">
  <div class="container">
    <div class="search-container" style="background: mintcream">
      <form class="search-form" >
        <div class="search-row">
          <div class="search-field location-field">
            <label for="location">
              <i class="fas fa-map-marker-alt"></i>
            </label>
            <select id="location" name="location">
              <option value="all">All Locations</option>
              <option value="new-york">New York</option>
              <option value="los-angeles">Los Angeles</option>
              <option value="chicago">Chicago</option>
              <option value="houston">Houston</option>
              <option value="miami">Miami</option>
            </select>
          </div>

          <div class="search-field keyword-field">
            <label for="keyword">
              <i class="fas fa-search"></i>
            </label>
            <input type="text" id="keyword" name="keyword" placeholder="What service are you looking for?">
          </div>

          <div class="search-field category-field">
            <label for="category">
              <i class="fas fa-tags"></i>
            </label>
            <select id="category" name="category">
              <option value="all">All Categories</option>
              <option value="1">Web Design</option>
              <option value="2">App Development</option>
              <option value="3">SEO</option>
              <option value="4">Graphic Design</option>
              <option value="5">Digital Marketing</option>
              <option value="6">Photography</option>
            </select>
          </div>

          <button type="submit" class="search-button">
            Search
          </button>
        </div>

        <div class="advanced-filters">
          <div class="filter-toggle">
            <i class="fas fa-sliders-h"></i> Advanced Filters
          </div>

          <div class="filter-options">
            <div class="filter-group">
              <h4>Price Range</h4>
              <div class="range-slider">
                <input type="range" min="0" max="2000" value="1000" class="price-slider" id="priceRange">
                <div class="range-values">
                  <span>$0</span>
                  <span id="priceValue">$1000</span>
                  <span>$2000+</span>
                </div>
              </div>
            </div>

            <div class="filter-group">
              <h4>Rating</h4>
              <div class="rating-options">
                <label class="rating-option">
                  <input type="checkbox" value="5">
                  <span class="rating-stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                  </span>
                </label>
                <label class="rating-option">
                  <input type="checkbox" value="4">
                  <span class="rating-stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="far fa-star"></i>
                  </span> & up
                </label>
                <label class="rating-option">
                  <input type="checkbox" value="3">
                  <span class="rating-stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="far fa-star"></i>
                    <i class="far fa-star"></i>
                  </span> & up
                </label>
              </div>
            </div>

            <div class="filter-group">
              <h4>Availability</h4>
              <div class="availability-options">
                <label class="availability-option">
                  <input type="checkbox" value="today"> Available Today
                </label>
                <label class="availability-option">
                  <input type="checkbox" value="week"> Available This Week
                </label>
                <label class="availability-option">
                  <input type="checkbox" value="weekend"> Weekend Availability
                </label>
              </div>
            </div>

            <button type="button" class="apply-filters-btn">Apply Filters</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- Category Section (Improved) -->
<section class="category-section">
  <div class="category-container">
    <button class="add-btn" id="addCategoryBtn">Add category</button>
    <button class="scroll-btn scroll-left" id="scrollLeft">
      <i class="fas fa-chevron-left"></i>
    </button>
    <div class="category-wrapper" id="categoryWrapper">

      <!-- Categories will be loaded here by JavaScript -->
    </div>
    <button class="scroll-btn scroll-right" id="scrollRight">
      <i class="fas fa-chevron-right"></i>
    </button>
  </div>
</section>
<button class="add-btn" style="margin-left: 7vw" id="addServiceBtn">Add Service</button>
<!-- Service Section (Improved) -->
<section class="service-section">
  <h2 class="section-title" id="serviceTitle" style="margin-left: 1vw">Web Design Services</h2>
  <div class="service-container" id="serviceContainer">
    <!-- Services will be loaded here by JavaScript -->
  </div>
</section>


<!-- Footer -->
<footer class="footer">
  <div class="container">
    <div class="footer-content">
      <div class="footer-brand">
        <h3 class="footer-title">Ivory Veils</h3>
        <p class="footer-tagline">Making your beauty simpler and better</p>
      </div>

      <div class="footer-links">
        <div class="footer-section">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="#">Home</a></li>
            <li><a href="#">Services</a></li>
            <li><a href="#">About Us</a></li>
            <li><a href="#">Contact</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h4>Legal</h4>
          <ul>
            <li><a href="#">Privacy Policy</a></li>
            <li><a href="#">Terms of Service</a></li>
            <li><a href="#">Cookie Policy</a></li>
          </ul>
        </div>

        <div class="footer-section">
          <h4>Contact Us</h4>
          <ul>
            <li><i class="fas fa-map-marker-alt"></i> 45 Elegant Ave, Ivory Veils Salon, Maharagama</li>
            <li><i class="fas fa-phone"></i> +94 77 123 4567</li>
            <li><i class="fas fa-envelope"></i> contact@ivoryveilssalon.com</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="footer-bottom">
      <div class="social-links">
        <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
        <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="#" aria-label="Pinterest"><i class="fab fa-pinterest"></i></a>
        <a href="#" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
      </div>

      <p class="copyright">&copy; 2025 Ivory Veils Salon. All rights reserved.</p>

      <div class="footer-legal">
        <a href="#">Privacy Policy</a>
        <span>|</span>
        <a href="#">Terms of Service</a>
        <span>|</span>
        <a href="#">Sitemap</a>
      </div>
    </div>
  </div>
</footer>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.5/dist/sweetalert2.all.min.js"></script>

<!--<script>// Toggle mobile menu
const hamburger = document.getElementById('hamburger');
const navLinks = document.querySelector('.nav-links');

hamburger.addEventListener('click', () => {
  navLinks.classList.toggle('active');
});
function logout() {
  localStorage.removeItem("token"); // Clear the token
  window.location.href = "login.html"; // Redirect to login page
}

// Add event listener to the logout link
document.querySelector('a[href="#logout"]').addEventListener('click', function(e) {
  e.preventDefault();
  logout();
});
</script>-->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    renderNavbar();
    window.addEventListener('storage', function(e) {
      if (e.key === 'token') {
        renderNavbar();
      }
    });
  });
  function renderNavbar() {
    const token = localStorage.getItem('token');
    const navbarContainer = document.querySelector('nav.navbar .container');

    if (!token) {
      // Render the logged-out navbar
      navbarContainer.innerHTML = `
      <a href="#" class="logo">Ivory Veils</a>
      <ul class="nav-links">
        <li><a href="../view/index.html">Home</a></li>
        <li><a href="../view/services.html"  style="color: white">Services</a></li>
        <li><a href="#about">About</a></li>
        <li><a href="#contact">Contact</a></li>
      </ul>
      <a href="../view/login.html" class="login-btn">
        <i class="fas fa-user"></i> Login
      </a>
      <div class="hamburger" id="hamburger">
        <i class="fas fa-bars"></i>
      </div>
    `;
    } else {
      try {
        // Decode the token to get the role
        const decoded = jwt_decode(token);
        const userRole = decoded.role; // Assuming your JWT has a 'role' claim

        // Redirect based on role
        if (userRole === 'ADMIN') {
          navbarContainer.innerHTML = `

    <a href="#" class="logo">Ivory Veils [Admin]</a>
    <ul class="nav-links">
      <li><a href="../view/admindashboard.html">Home</a></li>
      <li><a href="../view/users.html">Users</a></li>
      <li><a href="../view/services.html" style="color: white">Services</a></li>
    </ul>
    <a href="../view/profile.html" class="logout-btn">
      <i class="fas fa-user"></i> Profile
    </a>
    <div class="hamburger" id="hamburger">
      <i class="fas fa-bars"></i>
    </div>
          `;
        }else{
          // Render the logged-in navbar
          navbarContainer.innerHTML = `
      <a href="#" class="logo">Ivory Veils</a>
      <ul class="nav-links">
        <li><a href="#" onclick="navigateHome()">Home</a></li>
        <li><a href="../view/services.html" style="color: white">Services</a></li>
        <li><a href="../view/mybookings.html">Bookings</a></li>
      </ul>
      <a href="../view/profile.html" class="logout-btn">
        <i class="fas fa-user"></i> Profile
      </a>
      <div class="hamburger" id="hamburger">
        <i class="fas fa-bars"></i>
      </div>
    `;
        }
      } catch (error) {
        console.error('Error decoding token:', error);
        window.location.href = 'login.html';
      }

    }

    // Re-attach event listeners after rendering
    setupNavbarEvents();
  }
  function setupNavbarEvents() {
    // Hamburger menu toggle
    const hamburger = document.getElementById('hamburger');
    const navLinks = document.querySelector('.nav-links');

    if (hamburger && navLinks) {
      hamburger.addEventListener('click', () => {
        navLinks.classList.toggle('active');
      });
    }
  }

  document.getElementById('addServiceBtn').addEventListener('click', function() {
    // Navigate to add service page
    window.location.href = '../view/addService.html';
  });

  document.getElementById('addCategoryBtn').addEventListener('click', function() {
    // Navigate to add service page
    window.location.href = '../view/addCategory.html';
  });
  function navigateHome() {
    // Get the token from localStorage
    const token = localStorage.getItem('token');

    if (!token) {
      // If no token, redirect to login
      window.location.href = '../view/index.html';
      return;
    }

    try {
      // Decode the token to get the role
      const decoded = jwt_decode(token);
      const userRole = decoded.role; // Assuming your JWT has a 'role' claim

      // Redirect based on role
      if (userRole === 'CUSTOMER') {
        window.location.href = '../view/index.html';
      } else if (userRole === 'SERVICE_PROVIDER') {
        window.location.href = '../view/providerdashboard.html';
      } else {
        // Default fallback if role isn't recognized
        window.location.href = '../view/index.html';
      }
    } catch (error) {
      console.error('Error decoding token:', error);
      window.location.href = 'login.html';
    }
  }

  document.addEventListener("DOMContentLoaded", function () {

    // DOM Elements
    const categoryWrapper = document.getElementById("categoryWrapper");
    const serviceContainer = document.getElementById("serviceContainer");
    const serviceTitle = document.getElementById("serviceTitle");
    const scrollLeftBtn = document.getElementById("scrollLeft");
    const scrollRightBtn = document.getElementById("scrollRight");
    const searchForm = document.querySelector('.search-form');
    const filterToggle = document.querySelector('.filter-toggle');
    const filterOptions = document.querySelector('.filter-options');
    const priceRange = document.getElementById('priceRange');
    const priceValue = document.getElementById('priceValue');

    const token = localStorage.getItem("token");
    let role = null;
    let email = null;

    if (token) {
      try {
        const decodedToken = jwt_decode(token);

        role = decodedToken.role;
        email = decodedToken.sub;

        console.log("Decoded Token:", decodedToken);
        console.log("User Role:", role);

        if (role === "SERVICE_PROVIDER") {
          console.log("User is a Service Provider");
          document.getElementById("addCategoryBtn").style.display = "none";
        } else if (role === "CUSTOMER") {
          console.log("User is a Customer");
          document.getElementById("addCategoryBtn").style.display = "none";
          document.getElementById("addServiceBtn").style.display = "none";
        }  else if (role === "ADMIN") {
          console.log("User is a Admin");
          document.getElementById("addServiceBtn").style.display = "none";
        }
      } catch (error) {
        console.error("Failed to decode token:", error);
      }
    }
    else {
      console.log("token is null")
      document.getElementById("addCategoryBtn").style.display = "none";
      document.getElementById("addServiceBtn").style.display = "none";
    }

    const API_BASE_URL = "http://localhost:8080/api/v1";
    let activeCategoryId = 1;
    function fetchCategories() {
      $.ajax({
        url: `${API_BASE_URL}/categories/all`,
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          renderCategories(data.data.data);
          loadServices(activeCategoryId);
        },
        error: function(xhr, status, error) {
          console.error("Error fetching categories:", error);
          categoryWrapper.innerHTML = `<div class="error-message">Failed to load categories. Please try again later.</div>`;
        }
      });
    }

    function renderCategories(categories) {
      categoryWrapper.innerHTML = "";

      categories.forEach((category, index) => {
        const categoryElement = document.createElement("div");
        categoryElement.classList.add("category");

        if (index === 0) {
          categoryElement.classList.add("active");
          serviceTitle.textContent = `${category.categoryName} Services`;
          activeCategoryId = category.categoryId;
        }

        categoryElement.setAttribute("data-category", category.categoryId);

        // Admin controls (only for ADMIN role)
        const adminControls = role === 'ADMIN' ? `
      <div class="admin-controls">
        <button class="edit-category" data-id="${category.categoryId}">
          <i class="fas fa-edit"></i>
        </button>
        <button class="delete-category" data-id="${category.categoryId}">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    ` : '';

        categoryElement.innerHTML = `
      <img src="uploads/${category.image}" alt="${category.categoryName}">
      <span>${category.categoryName}</span>
      ${adminControls}
    `;

        // Click event for category selection
        categoryElement.addEventListener("click", (e) => {
          if (e.target.closest('.admin-controls')) return;

          document.querySelectorAll(".category").forEach(cat => {
            cat.classList.remove("active");
          });
          categoryElement.classList.add("active");
          activeCategoryId = category.categoryId;
          loadServices(category.categoryId);
          serviceTitle.textContent = `${category.categoryName} Services`;
        });

        categoryWrapper.appendChild(categoryElement);
      });

      // Add event listeners for admin buttons
      if (role === 'ADMIN') {
        document.querySelectorAll('.edit-category').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const categoryId = btn.getAttribute('data-id');
            editCategory(categoryId);
          });
        });

        document.querySelectorAll('.delete-category').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const categoryId = btn.getAttribute('data-id');
            deleteCategory(categoryId);
          });
        });
      }
    }

// Example functions (implement these)
    async function editCategory(categoryId) {
      try {
        // Fetch category details with authorization
        const response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.code == 200) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const category = await response.json();

        // Open edit modal/form with category data
        openCategoryEditModal(category.data);

      } catch (error) {
        console.error('Error fetching category:', error);
        alert('Failed to fetch category details. Please try again.');
        // You could also show a more user-friendly error message in the UI
      }
    }

    function openCategoryEditModal(category) {
      // Create modal HTML
      const modalHTML = `
    <div class="modal-overlay" id="categoryEditModal">
      <div class="modal-content">
        <h2>Edit Category</h2>
        <form id="editCategoryForm">
          <div class="form-group">
            <label>Category Name</label>
            <input type="text" name="categoryName" value="${escapeHtml(category.categoryName)}" required>
          </div>

          <div class="form-group">
            <label>Category Image</label>
            <input type="file" id="categoryImage" name="image" accept="image/*">
            ${category.image ? `
              <div class="current-image">
                <img src="uploads/${category.image}" style="max-width: 200px;">
                <input type="hidden" name="existingImage" value="${category.image}">
              </div>
            ` : ''}
          </div>

          <input type="hidden" name="categoryId" value="${category.categoryId}">

          <div class="modal-actions">
            <button type="submit" class="save-btn">Save Changes</button>
            <button type="button" class="cancel-btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  `;

      // Add to DOM
      document.body.insertAdjacentHTML('beforeend', modalHTML);

      // Add event listeners
      document.getElementById('editCategoryForm').addEventListener('submit', handleCategoryUpdate);
      document.querySelector('.cancel-btn').addEventListener('click', () => {
        document.getElementById('categoryEditModal').remove();
      });
    }

// Escape HTML to prevent XSS
    function escapeHtml(unsafe) {
      return unsafe
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
    }

    async function handleCategoryUpdate(e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);

      // Create categoryDTO object from form data
      const categoryDTO = {
        categoryId: parseInt(formData.get('categoryId')),
        categoryName: formData.get('categoryName'),
        image: formData.get('existingImage') // Preserve existing image by default
      };

      // Create new FormData for the request
      const requestFormData = new FormData();

      // Append categoryDTO as JSON blob
      requestFormData.append('categoryDTO',
              new Blob([JSON.stringify(categoryDTO)], { type: 'application/json' }));

      // Only append file if a new one was selected
      const fileInput = document.getElementById('categoryImage');
      if (fileInput.files.length > 0 && fileInput.files[0].size > 0) {
        requestFormData.append('file', fileInput.files[0]);
      }

      try {
        const response = await fetch(`${API_BASE_URL}/categories/update`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: requestFormData
        });

        const result = await response.json();
        if (result.code === 200) {
          alert('Category updated successfully!');
          document.getElementById('categoryEditModal').remove();
          fetchCategories();
        } else {
          throw new Error(result.message || 'Update failed');
        }
      } catch (error) {
        console.error('Update error:', error);
        alert('Error updating category: ' + error.message);
      }
    }
    async function deleteCategory(categoryId) {
      if (!confirm('Are you sure you want to delete this category?')) return;

      try {
        // Check if category has associated services
        const checkResponse = await fetch(`${API_BASE_URL}/categories/${categoryId}/has-services`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!checkResponse.ok) {
          throw new Error('Failed to check category services');
        }

        const hasServices = await checkResponse.json();

        if (hasServices) {
          alert('Cannot delete this category because it has associated services. Please remove or reassign the services first.');
          return;
        }
        // If no services, proceed with deletion
        const deleteResponse = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (deleteResponse.ok) {
          alert('Category deleted successfully');
          fetchCategories(); // Refresh the list
        } else {
          throw new Error('Failed to delete category');
        }
      } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'Error processing category deletion');
      }
    }
    function loadServices(categoryId, filters = {}) {
      serviceContainer.innerHTML = `<div class="loading">Loading services...</div>`;
      let queryParams = $.param(filters);
      let url = `${API_BASE_URL}/services/by-category/${categoryId}`;
      if (queryParams) {
        url += `?${queryParams}`;
      }

      $.ajax({
        url: url,
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          if (role === 'CUSTOMER' || role === 'ADMIN' || role === null) {
            renderServices(data.data.data);
          }
          else if (role === 'SERVICE_PROVIDER') {
            $.ajax({
              url: 'http://localhost:8080/api/v1/users/getidbyemail',
              method: 'GET',
              data: { email: email },
              headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
              },
              dataType: 'json',
              success: function(providerData) {
                const providerId = providerData.data.data;
                const filteredServices = data.data.data.filter(
                        service => service.serviceProviderId === providerId
                );
                renderServices(filteredServices);
              },
              error: function(xhr, status, error) {
                console.error("Error fetching provider:", error);
                serviceContainer.innerHTML = `<div class="error-message">Failed to load your services. Please try again later.</div>`;
              }
            });
          }
        },
        error: function(xhr, status, error) {
          console.error("Error fetching services:", error);
          serviceContainer.innerHTML = `<div class="error-message">Failed to load services. Please try again later.</div>`;
        }
      });}

    let service1;

    // Main render function
    function renderServices(services) {
      serviceContainer.innerHTML = "";

      if (services.length === 0) {
        serviceContainer.innerHTML = `<div class="no-results">No services found matching your criteria.</div>`;
        return;
      }

      services.forEach(service => {
        serviceContainer.appendChild(createServiceCard(service));
      });

      // Use event delegation for all service card interactions
      serviceContainer.addEventListener('click', handleServiceCardClick);
    }

// Create individual service card
    function createServiceCard(service) {
      const serviceElement = document.createElement("div");
      serviceElement.classList.add("service-card");
      serviceElement.dataset.serviceId = service.serviceId;

      serviceElement.innerHTML = `
    <img src="uploads/${service.image}" alt="${service.serviceName}">
    <div class="service-content">
      <h3>${service.serviceName}</h3>
      <p>${service.description}</p>
      <div class="service-footer">
        <span class="service-price">Fixed Price: ${service.fixedPrice}</span>
      </div>
      <div class="service-footer">
        <span>Additional charge: ${service.hourlyRate}</span>
      </div>
      <div class="service-footer">
        <span>${getRatingStars(service.rating || 3)}</span>
      </div>
      ${getActionButtons(service.serviceId)}
    </div>
  `;

      return serviceElement;
    }

// Get appropriate action buttons based on user role
    function getActionButtons(serviceId) {
      if (role === "SERVICE_PROVIDER") {
        return `
      <div class="service-actions">
        <button class="action-btn edit-btn" data-service-id="${serviceId}" aria-label="Edit service">
          <i class="fas fa-edit"></i>
        </button>
        <button class="action-btn delete-btn" data-service-id="${serviceId}" aria-label="Delete service">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
      } else if (role === "ADMIN") {
        return `
      <div class="service-actions">
        <button class="action-btn delete-btn" data-service-id="${serviceId}" aria-label="Delete service">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
      } else { // CUSTOMER or not logged in
        return `
      <button class="book-btn" data-service-id="${serviceId}">
        Book Now
      </button>
    `;
      }
    }

// Handle all service card interactions
    async function handleServiceCardClick(e) {
      const serviceId = e.target.closest('[data-service-id]')?.dataset.serviceId;
      if (!serviceId) return;

      // Book button
      if (e.target.closest('.book-btn')) {
        if (!role) {
          window.location.href = 'login.html';
          return;
        }
        bookService(serviceId);
      }

      // Delete button
      else if (e.target.closest('.delete-btn')) {
        if (confirm('Are you sure you want to delete this service?')) {
          await deleteService(serviceId);
        }
      }

      // Edit button
      else if (e.target.closest('.edit-btn')) {
        const service = await fetchServiceDetails(serviceId);
        service1 = service.data.data;
        openEditForm(service.data.data);
      }
    }

    // Add event listeners to book buttons
    document.querySelectorAll('.book-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const serviceId = this.getAttribute('data-service-id');
        if(role == null){
          window.location.href = 'login.html';
        }
        bookService(serviceId);
      });
    });

    async function deleteService(serviceId) {
      if (!confirm('Are you sure you want to delete this service?')) {
        return;
      }

      try {
        // First check if service has associated bookings
        const checkResponse = await fetch(`http://localhost:8080/api/v1/services/${serviceId}/has-bookings`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!checkResponse.ok) {
          throw new Error('Failed to check service bookings');
        }

        const hasBookings = await checkResponse.json();

        if (hasBookings) {
          alert('Cannot delete this service because it has associated bookings. Please resolve the bookings first.');
          return;
        }
        const response = await fetch(`http://localhost:8080/api/v1/services/${serviceId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          const serviceCard = document.querySelector(`[data-service-id="${serviceId}"]`).closest('.service-card');
          if (serviceCard) {
            serviceCard.remove();
          }
          alert('Service deleted successfully');
        } else {
          const error = await response.json();
          alert(`Error deleting service: ${error.message}`);
        }
      } catch (error) {
        console.error('Error deleting service:', error);
        alert('Failed to delete service');
      }
    }

    async function fetchServiceDetails(serviceId) {
      const response = await fetch(`http://localhost:8080/api/v1/services/${serviceId}`);
      return await response.json();
    }

    function openEditForm(service) {
      const form = `
    <div class="edit-form">
      <h3>Edit Service</h3>
      <form id="editServiceForm" enctype="multipart/form-data">
        <!-- Basic Information -->
        <div class="form-group">
          <label>Service Name</label>
          <input type="text" name="serviceName" value="${escapeHtml(service.serviceName || '')}" required>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea name="description" required>${escapeHtml(service.description || '')}</textarea>
        </div>

        <!-- Pricing -->
        <div class="form-group">
          <label>Fixed Price (Rs.)</label>
          <input type="number" name="fixedPrice" value="${service.fixedPrice || ''}" step="0.01">
        </div>

        <div class="form-group">
          <label>Hourly Rate (Rs./hr)</label>
          <input type="number" name="hourlyRate" value="${service.hourlyRate || ''}" step="0.01">
        </div>

        <!-- Image Upload -->
        <div class="form-group">
          <label>Service Image</label>
          ${service.image ? `
            <div class="current-image">
              <img src="uploads/${service.image}" alt="Current service image" style="max-width: 200px; display: block; margin-bottom: 10px;">
            </div>
            <input type="hidden" name="existingImage" value="${service.image}">
          ` : ''}
          <input type="file" name="image" accept="image/*">
        </div>

        <!-- Hidden Fields -->
        <input type="hidden" name="serviceId" value="${service.serviceId}">

        <!-- Buttons -->
        <div class="form-actions">
          <button type="submit" class="save-btn">Save Changes</button>
          <button type="button" class="cancel-edit">Cancel</button>
        </div>
      </form>
    </div>
  `;

      document.body.insertAdjacentHTML('beforeend', form);

      const editForm = document.getElementById('editServiceForm');
      editForm.addEventListener('submit', handleEditSubmit);

      document.querySelector('.cancel-edit').addEventListener('click', () => {
        document.querySelector('.edit-form').remove();
      });
    }
    async function handleEditSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      // Get form values
      const serviceName = formData.get('serviceName').trim();
      const description = formData.get('description').trim();
      const fixedPriceStr = formData.get('fixedPrice').trim();
      const hourlyRateStr = formData.get('hourlyRate').trim();
      const fileInput = form.querySelector('input[type="file"]');

      // Validation checks
      if (!serviceName) {
        Swal.fire({ icon: 'warning', title: 'Warning', text: 'Service Name is required.' });
        return;
      }

      if (serviceName.length > 100) {
        Swal.fire({ icon: 'warning', title: 'Warning', text: 'Service Name cannot exceed 100 characters.' });
        return;
      }

      if (!description) {
        Swal.fire({ icon: 'warning', title: 'Warning', text: 'Description is required.' });
        return;
      }

      if (description.length > 500) {
        Swal.fire({ icon: 'warning', title: 'Warning', text: 'Description cannot exceed 500 characters.' });
        return;
      }

      let fixedPrice = parseFloat(fixedPriceStr);
      if (fixedPriceStr && isNaN(fixedPrice)) {
        Swal.fire({ icon: 'warning', title: 'Warning', text: 'Fixed Price must be a valid number.' });
        return;
      } else if (fixedPrice < 0) {
        Swal.fire({ icon: 'warning', title: 'Warning', text: 'Fixed Price cannot be negative.' });
        return;
      }

      let hourlyRate = parseFloat(hourlyRateStr);
      if (hourlyRateStr && isNaN(hourlyRate)) {
        Swal.fire({ icon: 'warning', title: 'Warning', text: 'Hourly Rate must be a valid number.' });
        return;
      } else if (hourlyRate < 0) {
        Swal.fire({ icon: 'warning', title: 'Warning', text: 'Hourly Rate cannot be negative.' });
        return;
      }

      // Create serviceDTO object from form data
      const serviceDTO = {
        serviceId: parseInt(formData.get('serviceId')),
        serviceName: serviceName,
        description: description,
        fixedPrice: isNaN(fixedPrice) ? null : fixedPrice, // Use null if not a valid number
        hourlyRate: isNaN(hourlyRate) ? null : hourlyRate, // Use null if not a valid number
        image: formData.get('existingImage'),
        categoryId: service1.categoryId,
        serviceProviderId: service1.serviceProviderId // Assuming service1 is defined elsewhere
      };

      // Create new FormData for the request
      const requestFormData = new FormData();

      // Append serviceDTO as JSON blob
      requestFormData.append('serviceDTO',
              new Blob([JSON.stringify(serviceDTO)], { type: 'application/json' }));

      // Only append file if a new one was selected and has a size greater than 0
      if (fileInput.files.length > 0 && fileInput.files[0].size > 0) {
        // Basic file type validation (you might want to enhance this)
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(fileInput.files[0].type)) {
          Swal.fire({ icon: 'warning', title: 'Warning', text: 'Invalid file type. Only JPEG, PNG, and GIF are allowed.' });
          return;
        }
        // Basic file size validation (adjust as needed)
        const maxSizeMB = 2;
        if (fileInput.files[0].size > maxSizeMB * 1024 * 1024) {
          Swal.fire({ icon: 'warning', title: 'Warning', text: `File size exceeds the limit of ${maxSizeMB}MB.` });
          return;
        }
        requestFormData.append('file', fileInput.files[0]);
      }

      try {
        const response = await fetch('http://localhost:8080/api/v1/services/update', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: requestFormData
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(error || 'Update failed');
        }

        const result = await response.json();
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: result.message || 'Service updated successfully!',
          timer: 1500,
          showConfirmButton: false
        }).then(() => {
          const editForm = document.querySelector('.edit-form');
          if (editForm) {
            editForm.remove();
          }
          // Refresh services
          if (typeof loadServices === 'function') {
            loadServices(activeCategoryId);
          } else {
            location.reload();
          }
        });
      } catch (error) {
        console.error('Update error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Oops...',
          text: 'Error updating service: ' + error.message,
        });
      }
    }

    function escapeHtml(unsafe) {
      return unsafe
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
    }

    function bookService(serviceId) {
      if (!isUserLoggedIn()) {
        return;
      }
      window.location.href = '../view/booking.html?serviceId=' + serviceId;
    }

    function isUserLoggedIn() {
      return localStorage.getItem('token') !== null;
    }

    // Generate star rating HTML
    function getRatingStars(rating) {
      let stars = '';
      const fullStars = Math.floor(rating);
      const halfStar = rating % 1 >= 0.5;

      for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star"></i>';
      }

      if (halfStar) {
        stars += '<i class="fas fa-star-half-alt"></i>';
      }

      // Add remaining empty stars
      const emptyStars = 5 - Math.ceil(rating);
      for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star"></i>';
      }

      return stars;
    }

    // Event listeners for category scrolling
    scrollLeftBtn.addEventListener("click", () => {
      categoryWrapper.scrollBy({ left: -300, behavior: "smooth" });
    });

    scrollRightBtn.addEventListener("click", () => {
      categoryWrapper.scrollBy({ left: 300, behavior: "smooth" });
    });

    // Toggle advanced filters
    filterToggle.addEventListener('click', function() {
      filterOptions.style.display = filterOptions.style.display === 'none' || filterOptions.style.display === ''
              ? 'grid'
              : 'none';
    });

    // Update price range value
    priceRange.addEventListener('input', function() {
      priceValue.textContent = '$' + this.value;
    });

    // Handle search form submission
    searchForm.addEventListener('submit', function(e) {
      e.preventDefault();

      // Get form values
      const location = document.getElementById('location').value;
      const keyword = document.getElementById('keyword').value;
      const category = document.getElementById('category').value;
      const price = document.getElementById('priceRange').value;

      // Get ratings (checked checkboxes)
      const ratingCheckboxes = document.querySelectorAll('.rating-option input:checked');
      const ratings = Array.from(ratingCheckboxes).map(cb => cb.value);

      // Get availability options
      const availabilityCheckboxes = document.querySelectorAll('.availability-option input:checked');
      const availability = Array.from(availabilityCheckboxes).map(cb => cb.value);

      // Create search params object
      const searchParams = {
        location,
        keyword,
        price,
        ratings: ratings.join(','),
        availability: availability.join(',')
      };

      // If a specific category is selected, use that category
      if (category !== 'all') {
        activeCategoryId = parseInt(category);
        // Update active category in the UI
        document.querySelectorAll('.category').forEach(el => {
          el.classList.remove('active');
          if (el.getAttribute('data-category') === category) {
            el.classList.add('active');
          }
        });

        // Update the title
        const selectedCategory = document.querySelector(`.category[data-category="${category}"]`);
        if (selectedCategory) {
          serviceTitle.textContent = `${selectedCategory.querySelector('span').textContent} Services`;
        }
      }

      // Load services with filters
      loadServices(activeCategoryId, searchParams);

      // Scroll to services section
      document.querySelector('.service-section').scrollIntoView({
        behavior: 'smooth'
      });

      // Hide filter options after search
      filterOptions.style.display = 'none';
    });
    fetchCategories();
  });
</script>
</body>
</html>