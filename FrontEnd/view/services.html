<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ivory Veils Salon - Services</title>
  <link rel="stylesheet" href="../css/service.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background-color: #fdfaf6;
      color: #4b3e2e;
    }

    .navbar {
      background: linear-gradient(10deg, #c8ad7f, #a1866f);
      padding: 0.7rem 0;
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-radius: 0 0 15px 15px;
    }

    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .search-section {
      padding: 2rem 0;
    }

    .search-container {
      background-color: #fffaf0;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .section-title {
      font-size: 2rem;
      color: #a1866f;
    }

    .add-btn {
      background-color: #a1866f;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 1rem 0;
    }

    .add-btn:hover {
      background-color: #8c7159;
    }

    .service-section {
      background-color: #fff;
      padding: 2rem 0;
      border-top: 2px solid #eee0d0;
    }

    .service-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 1rem;
    }

    .category-section {
      padding: 1rem 0;
    }

    .category-container {
      display: flex;
      align-items: center;
      position: relative;
    }

    .category-wrapper {
      display: flex;
      overflow-x: auto;
      gap: 15px;
    }

    .scroll-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: #a1866f;
    }

    .footer {
      background-color: #4b3e2e;
      color: #fffaf0;
      padding: 1rem 0;
      text-align: center;
    }

    .footer .social-links a {
      color: #fffaf0;
      margin: 0 10px;
      font-size: 1.2rem;
      text-decoration: none;
    }

    .footer .social-links a:hover {
      color: #c8ad7f;
    }

    .search-form input,
    .search-form select {
      border: 1px solid #d6cfc2;
      padding: 0.5rem;
      border-radius: 5px;
      width: 100%;
    }

    .search-button, .apply-filters-btn {
      background-color: #a1866f;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .search-button:hover, .apply-filters-btn:hover {
      background-color: #8c7159;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <div class="container">
    <h1 style="margin: 0; font-family: cursive;">Ivory Veils Salon</h1>
  </div>
</nav>

<!-- Search Section -->
<section class="search-section">
  <div class="container">
    <div class="search-container">
      <form class="search-form">
        <div class="search-row">
          <div class="search-field location-field">
            <label for="location"><i class="fas fa-map-marker-alt"></i></label>
            <select id="location" name="location">
              <option value="all">All Branches</option>
              <option value="colombo">Colombo</option>
              <option value="maharagama">Maharagama</option>
              <option value="kandy">Kandy</option>
              <option value="galle">Galle</option>
            </select>
          </div>

          <div class="search-field keyword-field">
            <label for="keyword"><i class="fas fa-search"></i></label>
            <input type="text" id="keyword" name="keyword" placeholder="Search for hair, makeup, etc.">
          </div>

          <div class="search-field category-field">
            <label for="category"><i class="fas fa-tags"></i></label>
            <select id="category" name="category">
              <option value="all">All Services</option>
              <option value="1">Hair Styling</option>
              <option value="2">Makeup</option>
              <option value="3">Facials</option>
              <option value="4">Bridal Packages</option>
              <option value="5">Waxing</option>
              <option value="6">Nail Art</option>
            </select>
          </div>

          <button type="submit" class="search-button">Search</button>
        </div>

        <div class="advanced-filters">
          <div class="filter-toggle"><i class="fas fa-sliders-h"></i> Advanced Filters</div>

          <div class="filter-options">
            <div class="filter-group">
              <h4>Price Range</h4>
              <input type="range" min="0" max="10000" value="5000" class="price-slider" id="priceRange">
              <div class="range-values">
                <span>Rs. 0</span>
                <span id="priceValue">Rs. 5000</span>
                <span>Rs. 10,000+</span>
              </div>
            </div>

            <div class="filter-group">
              <h4>Rating</h4>
              <label><input type="checkbox" value="5"> <i class="fas fa-star"></i> 5 Stars</label>
              <label><input type="checkbox" value="4"> <i class="fas fa-star"></i> 4+ Stars</label>
              <label><input type="checkbox" value="3"> <i class="fas fa-star"></i> 3+ Stars</label>
            </div>

            <div class="filter-group">
              <h4>Availability</h4>
              <label><input type="checkbox" value="today"> Available Today</label>
              <label><input type="checkbox" value="week"> This Week</label>
              <label><input type="checkbox" value="weekend"> Weekend</label>
            </div>

            <button type="button" class="apply-filters-btn">Apply Filters</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- Category Section -->
<section class="category-section">
  <div class="container category-container">
    <button class="add-btn" id="addCategoryBtn">Add Service Category</button>
    <button class="scroll-btn scroll-left" id="scrollLeft"><i class="fas fa-chevron-left"></i></button>
    <div class="category-wrapper" id="categoryWrapper">
      <!-- Categories loaded via JS -->
    </div>
    <button class="scroll-btn scroll-right" id="scrollRight"><i class="fas fa-chevron-right"></i></button>
  </div>
</section>

<!-- Add Service Button -->
<div class="container">
  <button class="add-btn" id="addServiceBtn">Add New Service</button>
</div>

<!-- Service Display -->
<section class="service-section">
  <div class="container">
    <h2 class="section-title" id="serviceTitle">Salon Services</h2>
    <div class="service-container" id="serviceContainer">
      <!-- Services loaded via JavaScript -->
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="footer">
  <div class="container">
    <p>&copy; 2025 Ivory Veils Salon. All rights reserved.</p>
    <div class="social-links">
      <a href="#"><i class="fab fa-facebook"></i></a>
      <a href="#"><i class="fab fa-twitter"></i></a>
      <a href="#"><i class="fab fa-instagram"></i></a>
    </div>
  </div>
</footer>

<script src="../js/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
<script src="../js/service.js"></script>
</body>
</html>


<script>
  document.addEventListener('DOMContentLoaded', function() {
    renderNavbar();
    window.addEventListener('storage', function(e) {
      if (e.key === 'token') {
        renderNavbar();
      }
    });
  });
  function renderNavbar() {
    const token = localStorage.getItem('token');
    const navbarContainer = document.querySelector('nav.navbar .container');

    if (!token) {
      // Render the logged-out navbar
      navbarContainer.innerHTML = `
      <a href="#" class="logo">Ivory_Veils</a>
      <ul class="nav-links">
        <li><a href="../view/index.html">Home</a></li>
        <li><a href="../view/services.html">Services</a></li>
        <li><a href="#about">About</a></li>
        <li><a href="#contact">Contact</a></li>
      </ul>
      <a href="../view/login.html" class="login-btn">
        <i class="fas fa-user"></i> Login
      </a>
      <div class="hamburger" id="hamburger">
        <i class="fas fa-bars"></i>
      </div>
    `;
    } else {
      try {
        // Decode the token to get the role
        const decoded = jwt_decode(token);
        const userRole = decoded.role; // Assuming your JWT has a 'role' claim

        // Redirect based on role
        if (userRole === 'ADMIN') {
          navbarContainer.innerHTML = `

    <a href="#" class="logo">Ivory_Veils [Admin]</a>
    <ul class="nav-links">
      <li><a href="../view/admindashboard.html">Home</a></li>
      <li><a href="../view/users.html">Users</a></li>
      <li><a href="../view/services.html" style="color: white">Services</a></li>
    </ul>
    <a href="../view/profile.html" class="logout-btn">
      <i class="fas fa-user"></i> Profile
    </a>
    <div class="hamburger" id="hamburger">
      <i class="fas fa-bars"></i>
    </div>
          `;
        }else{
          // Render the logged-in navbar
          navbarContainer.innerHTML = `
      <a href="#" class="logo">Ivory_Veils</a>
      <ul class="nav-links">
        <li><a href="#" onclick="navigateHome()">Home</a></li>
        <li><a href="../view/services.html">Services</a></li>
        <li><a href="../view/mybookings.html">Bookings</a></li>
        <li><a href="../view/notifications.html">Notifications</a></li>
      </ul>
      <a href="../view/profile.html" class="logout-btn">
        <i class="fas fa-user"></i> Profile
      </a>
      <div class="hamburger" id="hamburger">
        <i class="fas fa-bars"></i>
      </div>
    `;
        }
      } catch (error) {
        console.error('Error decoding token:', error);
        window.location.href = 'login.html';
      }

    }

    // Re-attach event listeners after rendering
    setupNavbarEvents();
  }
  function setupNavbarEvents() {
    // Hamburger menu toggle
    const hamburger = document.getElementById('hamburger');
    const navLinks = document.querySelector('.nav-links');

    if (hamburger && navLinks) {
      hamburger.addEventListener('click', () => {
        navLinks.classList.toggle('active');
      });
    }
  }

  document.getElementById('addServiceBtn').addEventListener('click', function() {
    // Navigate to add service page
    window.location.href = '../view/addService.html';
  });

  document.getElementById('addCategoryBtn').addEventListener('click', function() {
    // Navigate to add service page
    window.location.href = '../view/addCategory.html';
  });
  function navigateHome() {
    // Get the token from localStorage
    const token = localStorage.getItem('token');

    if (!token) {
      // If no token, redirect to login
      window.location.href = '../view/index.html';
      return;
    }

    try {
      // Decode the token to get the role
      const decoded = jwt_decode(token);
      const userRole = decoded.role; // Assuming your JWT has a 'role' claim

      // Redirect based on role
      if (userRole === 'CUSTOMER') {
        window.location.href = '../view/index.html';
      } else if (userRole === 'MANAGER') {
        window.location.href = 'managerdashboard.html';
      } else {
        // Default fallback if role isn't recognized
        window.location.href = '../view/index.html';
      }
    } catch (error) {
      console.error('Error decoding token:', error);
      window.location.href = 'login.html';
    }
  }

  document.addEventListener("DOMContentLoaded", function () {

    // DOM Elements
    const categoryWrapper = document.getElementById("categoryWrapper");
    const serviceContainer = document.getElementById("serviceContainer");
    const serviceTitle = document.getElementById("serviceTitle");
    const scrollLeftBtn = document.getElementById("scrollLeft");
    const scrollRightBtn = document.getElementById("scrollRight");
    const searchForm = document.querySelector('.search-form');
    const filterToggle = document.querySelector('.filter-toggle');
    const filterOptions = document.querySelector('.filter-options');
    const priceRange = document.getElementById('priceRange');
    const priceValue = document.getElementById('priceValue');

    const token = localStorage.getItem("token");
    let role = null;
    let email = null;

    if (token) {
      try {
        const decodedToken = jwt_decode(token);

        role = decodedToken.role;
        email = decodedToken.sub;

        console.log("Decoded Token:", decodedToken);
        console.log("User Role:", role);

        if (role === "MANAGER") {
          console.log("User is a Service Provider");
          document.getElementById("addCategoryBtn").style.display = "none";
        } else if (role === "CUSTOMER") {
          console.log("User is a Customer");
          document.getElementById("addCategoryBtn").style.display = "none";
          document.getElementById("addServiceBtn").style.display = "none";
        }  else if (role === "ADMIN") {
          console.log("User is a Admin");
          document.getElementById("addServiceBtn").style.display = "none";
        }
      } catch (error) {
        console.error("Failed to decode token:", error);
      }
    }
    else {
      console.log("token is null")
      document.getElementById("addCategoryBtn").style.display = "none";
      document.getElementById("addServiceBtn").style.display = "none";
    }

    const API_BASE_URL = "http://localhost:8080/api/v1";
    let activeCategoryId = 1;
    function fetchCategories() {
      $.ajax({
        url: `${API_BASE_URL}/categories/all`,
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          renderCategories(data.data.data);
          loadServices(activeCategoryId);
        },
        error: function(xhr, status, error) {
          console.error("Error fetching categories:", error);
          categoryWrapper.innerHTML = `<div class="error-message">Failed to load categories. Please try again later.</div>`;
        }
      });
    }

    function renderCategories(categories) {
      categoryWrapper.innerHTML = "";

      categories.forEach((category, index) => {
        const categoryElement = document.createElement("div");
        categoryElement.classList.add("category");

        if (index === 0) {
          categoryElement.classList.add("active");
          serviceTitle.textContent = `${category.categoryName} Services`;
          activeCategoryId = category.categoryId;
        }

        categoryElement.setAttribute("data-category", category.categoryId);

        // Admin controls (only for ADMIN role)
        const adminControls = role === 'ADMIN' ? `
      <div class="admin-controls">
        <button class="edit-category" data-id="${category.categoryId}">
          <i class="fas fa-edit"></i>
        </button>
        <button class="delete-category" data-id="${category.categoryId}">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    ` : '';

        categoryElement.innerHTML = `
      <img src="uploads/${category.image}" alt="${category.categoryName}">
      <span>${category.categoryName}</span>
      ${adminControls}
    `;

        // Click event for category selection
        categoryElement.addEventListener("click", (e) => {
          if (e.target.closest('.admin-controls')) return;

          document.querySelectorAll(".category").forEach(cat => {
            cat.classList.remove("active");
          });
          categoryElement.classList.add("active");
          activeCategoryId = category.categoryId;
          loadServices(category.categoryId);
          serviceTitle.textContent = `${category.categoryName} Services`;
        });

        categoryWrapper.appendChild(categoryElement);
      });

      // Add event listeners for admin buttons
      if (role === 'ADMIN') {
        document.querySelectorAll('.edit-category').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const categoryId = btn.getAttribute('data-id');
            editCategory(categoryId);
          });
        });

        document.querySelectorAll('.delete-category').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const categoryId = btn.getAttribute('data-id');
            deleteCategory(categoryId);
          });
        });
      }
    }

// Example functions (implement these)
    async function editCategory(categoryId) {
      try {
        // Fetch category details with authorization
        const response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.code == 200) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const category = await response.json();

        // Open edit modal/form with category data
        openCategoryEditModal(category.data);

      } catch (error) {
        console.error('Error fetching category:', error);
        alert('Failed to fetch category details. Please try again.');
        // You could also show a more user-friendly error message in the UI
      }
    }

    function openCategoryEditModal(category) {
      // Create modal HTML
      const modalHTML = `
    <div class="modal-overlay" id="categoryEditModal">
      <div class="modal-content">
        <h2>Edit Category</h2>
        <form id="editCategoryForm">
          <div class="form-group">
            <label>Category Name</label>
            <input type="text" name="categoryName" value="${escapeHtml(category.categoryName)}" required>
          </div>

          <div class="form-group">
            <label>Category Image</label>
            <input type="file" id="categoryImage" name="image" accept="image/*">
            ${category.image ? `
              <div class="current-image">
                <img src="uploads/${category.image}" style="max-width: 200px;">
                <input type="hidden" name="existingImage" value="${category.image}">
              </div>
            ` : ''}
          </div>

          <input type="hidden" name="categoryId" value="${category.categoryId}">

          <div class="modal-actions">
            <button type="submit" class="save-btn">Save Changes</button>
            <button type="button" class="cancel-btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  `;

      // Add to DOM
      document.body.insertAdjacentHTML('beforeend', modalHTML);

      // Add event listeners
      document.getElementById('editCategoryForm').addEventListener('submit', handleCategoryUpdate);
      document.querySelector('.cancel-btn').addEventListener('click', () => {
        document.getElementById('categoryEditModal').remove();
      });
    }

// Escape HTML to prevent XSS
    function escapeHtml(unsafe) {
      return unsafe
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
    }

    async function handleCategoryUpdate(e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);

      // Create categoryDTO object from form data
      const categoryDTO = {
        categoryId: parseInt(formData.get('categoryId')),
        categoryName: formData.get('categoryName'),
        image: formData.get('existingImage') // Preserve existing image by default
      };

      // Create new FormData for the request
      const requestFormData = new FormData();

      // Append categoryDTO as JSON blob
      requestFormData.append('categoryDTO',
              new Blob([JSON.stringify(categoryDTO)], { type: 'application/json' }));

      // Only append file if a new one was selected
      const fileInput = document.getElementById('categoryImage');
      if (fileInput.files.length > 0 && fileInput.files[0].size > 0) {
        requestFormData.append('file', fileInput.files[0]);
      }

      try {
        const response = await fetch(`${API_BASE_URL}/categories/update`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: requestFormData
        });

        const result = await response.json();
        if (result.code === 200) {
          alert('Category updated successfully!');
          document.getElementById('categoryEditModal').remove();
          fetchCategories();
        } else {
          throw new Error(result.message || 'Update failed');
        }
      } catch (error) {
        console.error('Update error:', error);
        alert('Error updating category: ' + error.message);
      }
    }
    async function deleteCategory(categoryId) {
      if (!confirm('Are you sure you want to delete this category?')) return;

      try {
        // Check if category has associated services
        const checkResponse = await fetch(`${API_BASE_URL}/categories/${categoryId}/has-services`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!checkResponse.ok) {
          throw new Error('Failed to check category services');
        }

        const hasServices = await checkResponse.json();

        if (hasServices) {
          alert('Cannot delete this category because it has associated services. Please remove or reassign the services first.');
          return;
        }
        // If no services, proceed with deletion
        const deleteResponse = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (deleteResponse.ok) {
          alert('Category deleted successfully');
          fetchCategories(); // Refresh the list
        } else {
          throw new Error('Failed to delete category');
        }
      } catch (error) {
        console.error('Error:', error);
        alert(error.message || 'Error processing category deletion');
      }
    }
    function loadServices(categoryId, filters = {}) {
      serviceContainer.innerHTML = `<div class="loading">Loading services...</div>`;
      let queryParams = $.param(filters);
      let url = `${API_BASE_URL}/services/by-category/${categoryId}`;
      if (queryParams) {
        url += `?${queryParams}`;
      }

      $.ajax({
        url: url,
        method: 'GET',
        dataType: 'json',
        success: function(data) {
          if (role === 'CUSTOMER' || role === 'ADMIN' || role === null) {
            renderServices(data.data.data);
          }
          else if (role === 'SERVICE_PROVIDER') {
            $.ajax({
              url: 'http://localhost:8080/api/v1/users/getidbyemail',
              method: 'GET',
              data: { email: email },
              headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
              },
              dataType: 'json',
              success: function(providerData) {
                const providerId = providerData.data.data;
                const filteredServices = data.data.data.filter(
                        service => service.serviceProviderId === providerId
                );
                renderServices(filteredServices);
              },
              error: function(xhr, status, error) {
                console.error("Error fetching provider:", error);
                serviceContainer.innerHTML = `<div class="error-message">Failed to load your services. Please try again later.</div>`;
              }
            });
          }
        },
        error: function(xhr, status, error) {
          console.error("Error fetching services:", error);
          serviceContainer.innerHTML = `<div class="error-message">Failed to load services. Please try again later.</div>`;
        }
      });}

    let service1;

    // Main render function
    function renderServices(services) {
      serviceContainer.innerHTML = "";

      if (services.length === 0) {
        serviceContainer.innerHTML = `<div class="no-results">No services found matching your criteria.</div>`;
        return;
      }

      services.forEach(service => {
        serviceContainer.appendChild(createServiceCard(service));
      });

      // Use event delegation for all service card interactions
      serviceContainer.addEventListener('click', handleServiceCardClick);
    }

// Create individual service card
    function createServiceCard(service) {
      const serviceElement = document.createElement("div");
      serviceElement.classList.add("service-card");
      serviceElement.dataset.serviceId = service.serviceId;

      serviceElement.innerHTML = `
    <img src="uploads/${service.image}" alt="${service.serviceName}">
    <div class="service-content">
      <h3>${service.serviceName}</h3>
      <p>${service.description}</p>
      <div class="service-footer">
        <span class="service-price">Fixed Price: ${service.fixedPrice}</span>
      </div>
      <div class="service-footer">
        <span>Hourly Rate: ${service.hourlyRate}</span>
      </div>
      <div class="service-footer">
        <span>${getRatingStars(service.rating || 3)}</span>
      </div>
      ${getActionButtons(service.serviceId)}
    </div>
  `;

      return serviceElement;
    }

// Get appropriate action buttons based on user role
    function getActionButtons(serviceId) {
      if (role === "SERVICE_PROVIDER") {
        return `
      <div class="service-actions">
        <button class="action-btn edit-btn" data-service-id="${serviceId}" aria-label="Edit service">
          <i class="fas fa-edit"></i>
        </button>
        <button class="action-btn delete-btn" data-service-id="${serviceId}" aria-label="Delete service">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
      } else if (role === "ADMIN") {
        return `
      <div class="service-actions">
        <button class="action-btn delete-btn" data-service-id="${serviceId}" aria-label="Delete service">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    `;
      } else { // CUSTOMER or not logged in
        return `
      <button class="book-btn" data-service-id="${serviceId}">
        Book Now
      </button>
    `;
      }
    }

// Handle all service card interactions
    async function handleServiceCardClick(e) {
      const serviceId = e.target.closest('[data-service-id]')?.dataset.serviceId;
      if (!serviceId) return;

      // Book button
      if (e.target.closest('.book-btn')) {
        if (!role) {
          window.location.href = 'login.html';
          return;
        }
        bookService(serviceId);
      }

      // Delete button
      else if (e.target.closest('.delete-btn')) {
        if (confirm('Are you sure you want to delete this service?')) {
          await deleteService(serviceId);
        }
      }

      // Edit button
      else if (e.target.closest('.edit-btn')) {
        const service = await fetchServiceDetails(serviceId);
        service1 = service.data.data;
        openEditForm(service.data.data);
      }
    }

    // Add event listeners to book buttons
    document.querySelectorAll('.book-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const serviceId = this.getAttribute('data-service-id');
        if(role == null){
          window.location.href = 'login.html';
        }
        bookService(serviceId);
      });
    });

    async function deleteService(serviceId) {
      if (!confirm('Are you sure you want to delete this service?')) {
        return;
      }

      try {
        // First check if service has associated bookings
        const checkResponse = await fetch(`http://localhost:8080/api/v1/services/${serviceId}/has-bookings`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!checkResponse.ok) {
          throw new Error('Failed to check service bookings');
        }

        const hasBookings = await checkResponse.json();

        if (hasBookings) {
          alert('Cannot delete this service because it has associated bookings. Please resolve the bookings first.');
          return;
        }
        const response = await fetch(`http://localhost:8080/api/v1/services/${serviceId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (response.ok) {
          const serviceCard = document.querySelector(`[data-service-id="${serviceId}"]`).closest('.service-card');
          if (serviceCard) {
            serviceCard.remove();
          }
          alert('Service deleted successfully');
        } else {
          const error = await response.json();
          alert(`Error deleting service: ${error.message}`);
        }
      } catch (error) {
        console.error('Error deleting service:', error);
        alert('Failed to delete service');
      }
    }

    async function fetchServiceDetails(serviceId) {
      const response = await fetch(`http://localhost:8080/api/v1/services/${serviceId}`);
      return await response.json();
    }

    function openEditForm(service) {
      const form = `
    <div class="edit-form">
      <h3>Edit Service</h3>
      <form id="editServiceForm" enctype="multipart/form-data">
        <!-- Basic Information -->
        <div class="form-group">
          <label>Service Name</label>
          <input type="text" name="serviceName" value="${escapeHtml(service.serviceName || '')}" required>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea name="description" required>${escapeHtml(service.description || '')}</textarea>
        </div>

        <!-- Pricing -->
        <div class="form-group">
          <label>Fixed Price (Rs.)</label>
          <input type="number" name="fixedPrice" value="${service.fixedPrice || ''}" step="0.01">
        </div>

        <div class="form-group">
          <label>Hourly Rate (Rs./hr)</label>
          <input type="number" name="hourlyRate" value="${service.hourlyRate || ''}" step="0.01">
        </div>

        <!-- Image Upload -->
        <div class="form-group">
          <label>Service Image</label>
          ${service.image ? `
            <div class="current-image">
              <img src="uploads/${service.image}" alt="Current service image" style="max-width: 200px; display: block; margin-bottom: 10px;">
            </div>
            <input type="hidden" name="existingImage" value="${service.image}">
          ` : ''}
          <input type="file" name="image" accept="image/*">
        </div>

        <!-- Hidden Fields -->
        <input type="hidden" name="serviceId" value="${service.serviceId}">

        <!-- Buttons -->
        <div class="form-actions">
          <button type="submit" class="save-btn">Save Changes</button>
          <button type="button" class="cancel-edit">Cancel</button>
        </div>
      </form>
    </div>
  `;

      document.body.insertAdjacentHTML('beforeend', form);

      const editForm = document.getElementById('editServiceForm');
      editForm.addEventListener('submit', handleEditSubmit);

      document.querySelector('.cancel-edit').addEventListener('click', () => {
        document.querySelector('.edit-form').remove();
      });
    }

    async function handleEditSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      // Create serviceDTO object from form data
      const serviceDTO = {
        serviceId: parseInt(formData.get('serviceId')),
        serviceName: formData.get('serviceName'),
        description: formData.get('description'),
        fixedPrice: parseFloat(formData.get('fixedPrice')),
        hourlyRate: parseFloat(formData.get('hourlyRate')),
        image: formData.get('existingImage'),
        categoryId: service1.categoryId,
        serviceProviderId: service1.serviceProviderId// Preserve existing image by default
      };

      // Create new FormData for the request
      const requestFormData = new FormData();

      // Append serviceDTO as JSON blob
      requestFormData.append('serviceDTO',
              new Blob([JSON.stringify(serviceDTO)], { type: 'application/json' }));

      // Only append file if a new one was selected
      const fileInput = form.querySelector('input[type="file"]');
      if (fileInput.files.length > 0 && fileInput.files[0].size > 0) {
        requestFormData.append('file', fileInput.files[0]);
      }

      try {
        const response = await fetch('http://localhost:8080/api/v1/services/update', {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: requestFormData
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(error || 'Update failed');
        }

        const result = await response.json();
        alert(result.message || 'Service updated successfully!');
        document.querySelector('.edit-form').remove();

        // Refresh services
        if (typeof loadServices === 'function') {
          loadServices(activeCategoryId);
        } else {
          location.reload();
        }
      } catch (error) {
        console.error('Update error:', error);
        alert('Error updating service: ' + error.message);
      }
    }

    function escapeHtml(unsafe) {
      return unsafe
              .replace(/&/g, "&amp;")
              .replace(/</g, "&lt;")
              .replace(/>/g, "&gt;")
              .replace(/"/g, "&quot;")
              .replace(/'/g, "&#039;");
    }

    function bookService(serviceId) {
      if (!isUserLoggedIn()) {
        return;
      }
      window.location.href = '../view/booking.html?serviceId=' + serviceId;
    }

    function isUserLoggedIn() {
      return localStorage.getItem('token') !== null;
    }

    // Generate star rating HTML
    function getRatingStars(rating) {
      let stars = '';
      const fullStars = Math.floor(rating);
      const halfStar = rating % 1 >= 0.5;

      for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star"></i>';
      }

      if (halfStar) {
        stars += '<i class="fas fa-star-half-alt"></i>';
      }

      // Add remaining empty stars
      const emptyStars = 5 - Math.ceil(rating);
      for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star"></i>';
      }

      return stars;
    }

    // Event listeners for category scrolling
    scrollLeftBtn.addEventListener("click", () => {
      categoryWrapper.scrollBy({ left: -300, behavior: "smooth" });
    });

    scrollRightBtn.addEventListener("click", () => {
      categoryWrapper.scrollBy({ left: 300, behavior: "smooth" });
    });

    // Toggle advanced filters
    filterToggle.addEventListener('click', function() {
      filterOptions.style.display = filterOptions.style.display === 'none' || filterOptions.style.display === ''
              ? 'grid'
              : 'none';
    });

    // Update price range value
    priceRange.addEventListener('input', function() {
      priceValue.textContent = '$' + this.value;
    });

    // Handle search form submission
    searchForm.addEventListener('submit', function(e) {
      e.preventDefault();

      // Get form values
      const location = document.getElementById('location').value;
      const keyword = document.getElementById('keyword').value;
      const category = document.getElementById('category').value;
      const price = document.getElementById('priceRange').value;

      // Get ratings (checked checkboxes)
      const ratingCheckboxes = document.querySelectorAll('.rating-option input:checked');
      const ratings = Array.from(ratingCheckboxes).map(cb => cb.value);

      // Get availability options
      const availabilityCheckboxes = document.querySelectorAll('.availability-option input:checked');
      const availability = Array.from(availabilityCheckboxes).map(cb => cb.value);

      // Create search params object
      const searchParams = {
        location,
        keyword,
        price,
        ratings: ratings.join(','),
        availability: availability.join(',')
      };

      // If a specific category is selected, use that category
      if (category !== 'all') {
        activeCategoryId = parseInt(category);
        // Update active category in the UI
        document.querySelectorAll('.category').forEach(el => {
          el.classList.remove('active');
          if (el.getAttribute('data-category') === category) {
            el.classList.add('active');
          }
        });

        // Update the title
        const selectedCategory = document.querySelector(`.category[data-category="${category}"]`);
        if (selectedCategory) {
          serviceTitle.textContent = `${selectedCategory.querySelector('span').textContent} Services`;
        }
      }

      // Load services with filters
      loadServices(activeCategoryId, searchParams);

      // Scroll to services section
      document.querySelector('.service-section').scrollIntoView({
        behavior: 'smooth'
      });

      // Hide filter options after search
      filterOptions.style.display = 'none';
    });
    fetchCategories();
  });
</script>
</body>
</html>